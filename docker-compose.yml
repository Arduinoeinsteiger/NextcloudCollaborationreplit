version: '3.8'

networks:
  swissairdry:
    name: ${DOCKER_NETWORK_NAME:-swissairdry_network}
    driver: bridge

volumes:
  postgres_data:
  mqtt_data:
  mqtt_log:

services:
  # API-Server (FastAPI)
  api:
    build:
      context: ./swissairdry/api
      dockerfile: Dockerfile
    container_name: swissairdry_api
    restart: ${DOCKER_RESTART_POLICY:-unless-stopped}
    ports:
      - "${API_PORT:-5000}:5000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - MQTT_HOST=${MQTT_HOST:-mqtt}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - MQTT_USERNAME=${MQTT_USERNAME}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - MQTT_TOPIC_PREFIX=${MQTT_TOPIC_PREFIX:-swissairdry}
      - NEXTCLOUD_HOST=${NEXTCLOUD_HOST}
      - NEXTCLOUD_PORT=${NEXTCLOUD_PORT:-8080}
      - NEXTCLOUD_PROTOCOL=${NEXTCLOUD_PROTOCOL:-https}
      - NEXTCLOUD_APP_NAME=${NEXTCLOUD_APP_NAME:-swissairdry}
      - NEXTCLOUD_API_KEY=${NEXTCLOUD_API_KEY}
      - AUTH_SECRET_KEY=${AUTH_SECRET_KEY}
      - API_ALLOWED_ORIGINS=${API_ALLOWED_ORIGINS:-*}
      - APP_DEBUG=${APP_DEBUG:-false}
    volumes:
      - ./swissairdry/api:/app
    depends_on:
      - postgres
      - mqtt
    networks:
      - swissairdry

  # PostgreSQL Datenbank
  postgres:
    image: postgres:15-alpine
    container_name: swissairdry_postgres
    restart: ${DOCKER_RESTART_POLICY:-unless-stopped}
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-swissairdry}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-your_secure_db_password}
      - POSTGRES_DB=${POSTGRES_DB:-swissairdry}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - swissairdry

  # MQTT Broker (Mosquitto)
  mqtt:
    image: eclipse-mosquitto:2
    container_name: swissairdry_mqtt
    restart: ${DOCKER_RESTART_POLICY:-unless-stopped}
    ports:
      - "${MQTT_PORT:-1883}:1883"
      - "${MQTT_WS_PORT:-9001}:9001"
    volumes:
      - ./swissairdry/mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./swissairdry/mqtt/auth:/mosquitto/config/auth
      - mqtt_data:/mosquitto/data
      - mqtt_log:/mosquitto/log
    networks:
      - swissairdry

  # Nextcloud Integration (Optional, kann auf einem separaten Server laufen)
  nextcloud_app:
    image: nginx:alpine
    container_name: swissairdry_nextcloud_app
    restart: ${DOCKER_RESTART_POLICY:-unless-stopped}
    ports:
      - "${WEB_PORT:-8000}:80"
    volumes:
      - ./swissairdry/nextcloud:/usr/share/nginx/html
      - ./swissairdry/nextcloud/nginx.conf:/etc/nginx/conf.d/default.conf
    environment:
      - API_HOST=${API_HOST:-api}
      - API_PORT=${API_PORT:-5000}
      - API_PREFIX=${API_PREFIX:-/api}
    depends_on:
      - api
    networks:
      - swissairdry