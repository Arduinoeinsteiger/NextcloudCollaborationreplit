{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Gruppenliste -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user-tag me-2"></i>Benutzergruppen
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="groups-table">
                        <thead>
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Name</th>
                                <th scope="col">Beschreibung</th>
                                <th scope="col">Benutzer</th>
                                <th scope="col">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in groups %}
                            <tr>
                                <td>{{ group.id }}</td>
                                <td>{{ group.name }}</td>
                                <td>{{ group.description }}</td>
                                <td>
                                    <span class="badge bg-primary rounded-pill">{{ group.user_count }}</span>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-info btn-action" 
                                            data-bs-toggle="modal" data-bs-target="#viewGroupModal" 
                                            data-group-id="{{ group.id }}" data-group-name="{{ group.name }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary btn-action"
                                            data-bs-toggle="modal" data-bs-target="#editGroupUsersModal"
                                            data-group-id="{{ group.id }}" data-group-name="{{ group.name }}">
                                        <i class="fas fa-users"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ansicht Gruppendetails Modal -->
<div class="modal fade" id="viewGroupModal" tabindex="-1" aria-labelledby="viewGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewGroupModalLabel">Gruppendetails</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Hier werden die Gruppendetails geladen -->
                <div class="d-flex justify-content-center mb-3" id="group-details-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Wird geladen...</span>
                    </div>
                </div>
                <div id="group-details-content" style="display: none;">
                    <h4 id="group-name"></h4>
                    <p id="group-description"></p>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h5>API-Berechtigungen</h5>
                            <ul class="list-group" id="api-permissions-list">
                                <!-- API-Berechtigungen werden hier geladen -->
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>Dashboard-Module</h5>
                            <ul class="list-group" id="dashboard-modules-list">
                                <!-- Dashboard-Module werden hier geladen -->
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Benutzer in dieser Gruppe</h5>
                        <ul class="list-group" id="group-users-list">
                            <!-- Benutzer werden hier geladen -->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<!-- Benutzer bearbeiten Modal -->
<div class="modal fade" id="editGroupUsersModal" tabindex="-1" aria-labelledby="editGroupUsersModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGroupUsersModalLabel">Benutzer der Gruppe bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-center mb-3" id="edit-group-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Wird geladen...</span>
                    </div>
                </div>
                <div id="edit-group-content" style="display: none;">
                    <form id="edit-group-users-form">
                        <input type="hidden" id="edit-group-id" name="group_id">
                        
                        <div class="mb-3">
                            <label for="edit-group-name" class="form-label">Gruppenname</label>
                            <input type="text" class="form-control" id="edit-group-name" disabled>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Benutzer in dieser Gruppe</label>
                            <ul class="list-group" id="current-group-users">
                                <!-- Aktuelle Benutzer werden hier geladen -->
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <label for="add-user-select" class="form-label">Benutzer hinzufügen</label>
                            <div class="input-group">
                                <select class="form-select" id="add-user-select">
                                    <option value="" selected>Benutzer auswählen...</option>
                                    {% for user in all_users %}
                                    <option value="{{ user.id }}">{{ user.username }}</option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-outline-primary" type="button" id="add-user-btn">
                                    <i class="fas fa-plus"></i> Hinzufügen
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Alle Benutzergruppen laden
        loadAllGroups();
        
        // Event Handler für Gruppenansicht-Modal
        $('#viewGroupModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            const groupId = button.data('group-id');
            const groupName = button.data('group-name');
            
            // Modal aktualisieren
            $('#group-details-loading').show();
            $('#group-details-content').hide();
            
            // Gruppendetails laden
            loadGroupDetails(groupId);
        });
        
        // Event Handler für Gruppenbenutzerverwaltung-Modal
        $('#editGroupUsersModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            const groupId = button.data('group-id');
            const groupName = button.data('group-name');
            
            // Modal aktualisieren
            $('#edit-group-loading').show();
            $('#edit-group-content').hide();
            
            // Modal-Felder setzen
            $('#edit-group-id').val(groupId);
            $('#edit-group-name').val(groupName);
            
            // Benutzer der Gruppe laden
            loadGroupUsers(groupId);
        });
        
        // Event Handler für "Benutzer hinzufügen"-Button
        $('#add-user-btn').on('click', function() {
            const userId = $('#add-user-select').val();
            const groupId = $('#edit-group-id').val();
            
            if (userId) {
                addUserToGroup(userId, groupId);
            }
        });
    });
    
    // Alle Benutzergruppen laden
    function loadAllGroups() {
        apiRequest('/admin/api/groups')
            .then(data => {
                // Hier können Sie bei Bedarf zusätzliche Aktionen durchführen
                console.log('Alle Gruppen geladen:', data);
            })
            .catch(error => {
                console.error('Fehler beim Laden der Gruppen:', error);
                showAlert('Fehler beim Laden der Gruppen.', 'danger');
            });
    }
    
    // Gruppendetails laden
    function loadGroupDetails(groupId) {
        // API-Endpunkt zum Abrufen der Gruppendetails
        apiRequest(`/api/user-groups/${groupId}`)
            .then(data => {
                // Gruppeninformationen anzeigen
                $('#group-name').text(data.name);
                $('#group-description').text(data.description);
                
                // API-Berechtigungen anzeigen
                const permissionsList = $('#api-permissions-list');
                permissionsList.empty();
                if (data.api_permissions && data.api_permissions.length > 0) {
                    data.api_permissions.forEach(permission => {
                        permissionsList.append(`
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${permission.endpoint}
                                <span class="badge bg-primary rounded-pill">${permission.methods.join(', ')}</span>
                            </li>
                        `);
                    });
                } else {
                    permissionsList.append('<li class="list-group-item">Keine API-Berechtigungen</li>');
                }
                
                // Dashboard-Module anzeigen
                const modulesList = $('#dashboard-modules-list');
                modulesList.empty();
                if (data.dashboard_modules && data.dashboard_modules.length > 0) {
                    data.dashboard_modules.forEach(module => {
                        modulesList.append(`
                            <li class="list-group-item">${module}</li>
                        `);
                    });
                } else {
                    modulesList.append('<li class="list-group-item">Keine Dashboard-Module</li>');
                }
                
                // Benutzer in der Gruppe anzeigen
                loadGroupUsers(groupId, '#group-users-list');
                
                // Loading-Anzeige ausblenden und Inhalt anzeigen
                $('#group-details-loading').hide();
                $('#group-details-content').show();
            })
            .catch(error => {
                console.error('Fehler beim Laden der Gruppendetails:', error);
                showAlert('Fehler beim Laden der Gruppendetails.', 'danger');
                $('#group-details-loading').hide();
            });
    }
    
    // Benutzer einer Gruppe laden
    function loadGroupUsers(groupId, targetSelector = '#current-group-users') {
        apiRequest(`/admin/api/user/${groupId}/groups`)
            .then(data => {
                const usersList = $(targetSelector);
                usersList.empty();
                
                if (data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        if (targetSelector === '#current-group-users') {
                            // Für das Bearbeiten-Modal mit Entfernen-Button
                            usersList.append(`
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${user.username}
                                    <button type="button" class="btn btn-sm btn-danger remove-user-btn" 
                                            data-user-id="${user.id}" data-group-id="${groupId}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </li>
                            `);
                        } else {
                            // Für die Detailansicht ohne Entfernen-Button
                            usersList.append(`
                                <li class="list-group-item">
                                    ${user.username}
                                </li>
                            `);
                        }
                    });
                    
                    // Event-Handler für Entfernen-Buttons hinzufügen
                    if (targetSelector === '#current-group-users') {
                        $('.remove-user-btn').on('click', function() {
                            const userId = $(this).data('user-id');
                            const groupId = $(this).data('group-id');
                            removeUserFromGroup(userId, groupId);
                        });
                    }
                } else {
                    usersList.append('<li class="list-group-item">Keine Benutzer in dieser Gruppe</li>');
                }
                
                // Loading-Anzeige ausblenden und Inhalt anzeigen
                if (targetSelector === '#current-group-users') {
                    $('#edit-group-loading').hide();
                    $('#edit-group-content').show();
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Gruppenbenutzer:', error);
                showAlert('Fehler beim Laden der Gruppenbenutzer.', 'danger');
                
                if (targetSelector === '#current-group-users') {
                    $('#edit-group-loading').hide();
                }
            });
    }
    
    // Benutzer zu einer Gruppe hinzufügen
    function addUserToGroup(userId, groupId) {
        apiRequest(`/admin/api/user/${userId}/add_to_group/${groupId}`, 'POST')
        .then(data => {
            if (data.success) {
                showAlert('Benutzer wurde zur Gruppe hinzugefügt.', 'success');
                // Liste der Benutzer aktualisieren
                loadGroupUsers(groupId);
                // Auswahlfeld zurücksetzen
                $('#add-user-select').val('');
            } else {
                showAlert(data.message, 'warning');
            }
        })
        .catch(error => {
            console.error('Fehler beim Hinzufügen des Benutzers:', error);
            showAlert('Fehler beim Hinzufügen des Benutzers zur Gruppe.', 'danger');
        });
    }
    
    // Benutzer aus einer Gruppe entfernen
    function removeUserFromGroup(userId, groupId) {
        apiRequest(`/admin/api/user/${userId}/remove_from_group/${groupId}`, 'POST')
        .then(data => {
            if (data.success) {
                showAlert('Benutzer wurde aus der Gruppe entfernt.', 'success');
                // Liste der Benutzer aktualisieren
                loadGroupUsers(groupId);
            } else {
                showAlert(data.message, 'warning');
            }
        })
        .catch(error => {
            console.error('Fehler beim Entfernen des Benutzers:', error);
            showAlert('Fehler beim Entfernen des Benutzers aus der Gruppe.', 'danger');
        });
    }
</script>
{% endblock %}