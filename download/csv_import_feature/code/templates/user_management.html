{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Benutzerverwaltung</h5>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="fas fa-user-plus me-2"></i>Neuer Benutzer
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Benutzername</th>
                            <th>E-Mail</th>
                            <th>Vollständiger Name</th>
                            <th>Status</th>
                            <th>Gruppen</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.full_name or '-' }}</td>
                            <td>
                                <span class="badge {% if user.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                    {% if user.is_active %}Aktiv{% else %}Inaktiv{% endif %}
                                </span>
                                {% if user.is_admin %}
                                <span class="badge bg-warning ms-1">Admin</span>
                                {% endif %}
                            </td>
                            <td>
                                {% for group in user.groups %}
                                <span class="badge badge-group bg-info">{{ group.name }}</span>
                                {% endfor %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary btn-action" 
                                            onclick="editUser({{ user.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger btn-action" 
                                            onclick="confirmDeleteUser({{ user.id }}, '{{ user.username }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info btn-action" 
                                            onclick="manageUserGroups({{ user.id }}, '{{ user.username }}')">
                                        <i class="fas fa-user-tag"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Neuer Benutzer Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Neuen Benutzer anlegen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <form id="add-user-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">Benutzername</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">E-Mail</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Passwort</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="full_name" class="form-label">Vollständiger Name</label>
                        <input type="text" class="form-control" id="full_name" name="full_name">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" checked>
                        <label class="form-check-label" for="is_active">Aktiv</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="is_admin" name="is_admin">
                        <label class="form-check-label" for="is_admin">Administrator</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-success" id="submit-add-user">Speichern</button>
            </div>
        </div>
    </div>
</div>

<!-- Benutzer bearbeiten Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>Benutzer bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <form id="edit-user-form">
                    <input type="hidden" id="edit_user_id" name="id">
                    <div class="mb-3">
                        <label for="edit_username" class="form-label">Benutzername</label>
                        <input type="text" class="form-control" id="edit_username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_email" class="form-label">E-Mail</label>
                        <input type="email" class="form-control" id="edit_email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_password" class="form-label">Neues Passwort (leer lassen, um nicht zu ändern)</label>
                        <input type="password" class="form-control" id="edit_password" name="password">
                    </div>
                    <div class="mb-3">
                        <label for="edit_full_name" class="form-label">Vollständiger Name</label>
                        <input type="text" class="form-control" id="edit_full_name" name="full_name">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_is_active" name="is_active">
                        <label class="form-check-label" for="edit_is_active">Aktiv</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_is_admin" name="is_admin">
                        <label class="form-check-label" for="edit_is_admin">Administrator</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="submit-edit-user">Aktualisieren</button>
            </div>
        </div>
    </div>
</div>

<!-- Benutzergruppen verwalten Modal -->
<div class="modal fade" id="manageGroupsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-user-tag me-2"></i>Benutzergruppen verwalten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <h5 id="manage-groups-username" class="mb-3"></h5>
                <input type="hidden" id="manage_user_id">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Verfügbare Gruppen</h6>
                            </div>
                            <div class="card-body">
                                <div class="list-group" id="available-groups">
                                    <!-- Verfügbare Gruppen werden dynamisch geladen -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">Zugewiesene Gruppen</h6>
                            </div>
                            <div class="card-body">
                                <div class="list-group" id="assigned-groups">
                                    <!-- Zugewiesene Gruppen werden dynamisch geladen -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<!-- Benutzer löschen Bestätigungsmodal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Benutzer löschen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <p>Sind Sie sicher, dass Sie den Benutzer <strong id="delete-user-name"></strong> löschen möchten?</p>
                <p class="text-danger">Diese Aktion kann nicht rückgängig gemacht werden!</p>
                <input type="hidden" id="delete_user_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-user">Löschen</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Benutzer bearbeiten
    function editUser(userId) {
        // Benutzerinformationen abrufen
        apiRequest(`/api/users/${userId}`)
            .then(user => {
                // Formular mit Benutzerdaten füllen
                document.getElementById('edit_user_id').value = user.id;
                document.getElementById('edit_username').value = user.username;
                document.getElementById('edit_email').value = user.email;
                document.getElementById('edit_full_name').value = user.full_name || '';
                document.getElementById('edit_is_active').checked = user.is_active;
                document.getElementById('edit_is_admin').checked = user.is_admin;
                
                // Modal öffnen
                new bootstrap.Modal(document.getElementById('editUserModal')).show();
            })
            .catch(error => {
                showAlert(`Fehler beim Laden der Benutzerdaten: ${error.message}`, 'danger');
            });
    }
    
    // Bestätigung zum Löschen eines Benutzers
    function confirmDeleteUser(userId, username) {
        document.getElementById('delete_user_id').value = userId;
        document.getElementById('delete-user-name').textContent = username;
        new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
    }
    
    // Benutzergruppen verwalten
    function manageUserGroups(userId, username) {
        document.getElementById('manage_user_id').value = userId;
        document.getElementById('manage-groups-username').textContent = `Gruppen für: ${username}`;
        
        // Listen leeren
        document.getElementById('available-groups').innerHTML = '';
        document.getElementById('assigned-groups').innerHTML = '';
        
        // Gruppen und Benutzerzugehörigkeiten laden
        Promise.all([
            apiRequest('/api/groups'),
            apiRequest(`/api/users/${userId}`)
        ])
            .then(([groups, user]) => {
                const userGroupIds = (user.groups || []).map(g => g.id);
                
                // Verfügbare Gruppen anzeigen (die, in denen der Benutzer nicht ist)
                const availableGroups = groups.filter(g => !userGroupIds.includes(g.id));
                const availableGroupsContainer = document.getElementById('available-groups');
                
                if (availableGroups.length === 0) {
                    availableGroupsContainer.innerHTML = `
                        <div class="list-group-item text-muted">
                            Keine verfügbaren Gruppen
                        </div>
                    `;
                } else {
                    availableGroups.forEach(group => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item d-flex justify-content-between align-items-center';
                        item.innerHTML = `
                            <div>
                                <strong>${group.name}</strong>
                                <div><small class="text-muted">${group.description || ''}</small></div>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="addUserToGroup(${userId}, ${group.id})">
                                <i class="fas fa-plus"></i>
                            </button>
                        `;
                        availableGroupsContainer.appendChild(item);
                    });
                }
                
                // Zugewiesene Gruppen anzeigen
                const assignedGroupsContainer = document.getElementById('assigned-groups');
                
                if (!user.groups || user.groups.length === 0) {
                    assignedGroupsContainer.innerHTML = `
                        <div class="list-group-item text-muted">
                            Keine Gruppen zugewiesen
                        </div>
                    `;
                } else {
                    user.groups.forEach(group => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item d-flex justify-content-between align-items-center';
                        item.innerHTML = `
                            <div>
                                <strong>${group.name}</strong>
                                <div><small class="text-muted">${group.description || ''}</small></div>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="removeUserFromGroup(${userId}, ${group.id})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        assignedGroupsContainer.appendChild(item);
                    });
                }
                
                // Modal öffnen
                new bootstrap.Modal(document.getElementById('manageGroupsModal')).show();
            })
            .catch(error => {
                showAlert(`Fehler beim Laden der Gruppen: ${error.message}`, 'danger');
            });
    }
    
    // Benutzer zu Gruppe hinzufügen
    async function addUserToGroup(userId, groupId) {
        try {
            const result = await apiRequest(`/api/user/${userId}/add_to_group/${groupId}`, 'POST');
            if (result.success) {
                showAlert(`Benutzer zur Gruppe hinzugefügt`, 'success');
                manageUserGroups(userId, document.getElementById('manage-groups-username').textContent.replace('Gruppen für: ', ''));
            } else {
                showAlert(result.message, 'warning');
            }
        } catch (error) {
            showAlert(`Fehler beim Hinzufügen zur Gruppe: ${error.message}`, 'danger');
        }
    }
    
    // Benutzer aus Gruppe entfernen
    async function removeUserFromGroup(userId, groupId) {
        try {
            const result = await apiRequest(`/api/user/${userId}/remove_from_group/${groupId}`, 'POST');
            if (result.success) {
                showAlert(`Benutzer aus der Gruppe entfernt`, 'success');
                manageUserGroups(userId, document.getElementById('manage-groups-username').textContent.replace('Gruppen für: ', ''));
            } else {
                showAlert(result.message, 'warning');
            }
        } catch (error) {
            showAlert(`Fehler beim Entfernen aus der Gruppe: ${error.message}`, 'danger');
        }
    }
    
    // DOM Ready Event
    document.addEventListener('DOMContentLoaded', function() {
        // Neuen Benutzer erstellen
        document.getElementById('submit-add-user').addEventListener('click', async function() {
            const formData = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                full_name: document.getElementById('full_name').value,
                is_active: document.getElementById('is_active').checked,
                is_admin: document.getElementById('is_admin').checked
            };
            
            try {
                const result = await apiRequest('/api/users', 'POST', formData);
                if (result.id) {
                    showAlert('Benutzer erfolgreich erstellt', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    window.location.reload();
                }
            } catch (error) {
                showAlert(`Fehler beim Erstellen des Benutzers: ${error.message}`, 'danger');
            }
        });
        
        // Benutzer bearbeiten
        document.getElementById('submit-edit-user').addEventListener('click', async function() {
            const userId = document.getElementById('edit_user_id').value;
            const formData = {
                username: document.getElementById('edit_username').value,
                email: document.getElementById('edit_email').value,
                full_name: document.getElementById('edit_full_name').value,
                is_active: document.getElementById('edit_is_active').checked,
                is_admin: document.getElementById('edit_is_admin').checked
            };
            
            // Passwort nur senden, wenn es nicht leer ist
            const password = document.getElementById('edit_password').value;
            if (password) {
                formData.password = password;
            }
            
            try {
                const result = await apiRequest(`/api/users/${userId}`, 'PUT', formData);
                if (result.id) {
                    showAlert('Benutzer erfolgreich aktualisiert', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    window.location.reload();
                }
            } catch (error) {
                showAlert(`Fehler beim Aktualisieren des Benutzers: ${error.message}`, 'danger');
            }
        });
        
        // Benutzer löschen
        document.getElementById('confirm-delete-user').addEventListener('click', async function() {
            const userId = document.getElementById('delete_user_id').value;
            
            try {
                const result = await apiRequest(`/api/users/${userId}`, 'DELETE');
                showAlert('Benutzer erfolgreich gelöscht', 'success');
                bootstrap.Modal.getInstance(document.getElementById('deleteUserModal')).hide();
                window.location.reload();
            } catch (error) {
                showAlert(`Fehler beim Löschen des Benutzers: ${error.message}`, 'danger');
            }
        });
    });
</script>
{% endblock %}