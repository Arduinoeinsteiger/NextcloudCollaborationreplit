{% extends "base.html" %}

{% block title %}STM32 Geräte Dashboard{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .stm32-card {
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        transition: transform 0.3s ease;
    }
    
    .stm32-card:hover {
        transform: translateY(-5px);
    }
    
    .stm32-card .card-header {
        background-color: #3a7bd5;
        color: white;
        border-radius: 10px 10px 0 0;
        padding: 15px;
        font-weight: bold;
    }
    
    .stm32-card .card-body {
        padding: 20px;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 10px;
    }
    
    .status-online {
        background-color: #2ecc71;
    }
    
    .status-offline {
        background-color: #e74c3c;
    }
    
    .status-warning {
        background-color: #f39c12;
    }
    
    .data-value {
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .data-label {
        font-size: 0.9rem;
        color: #7f8c8d;
    }
    
    .chart-container {
        height: 200px;
        margin-top: 20px;
    }
    
    .command-container {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    @media (max-width: 768px) {
        .stm32-card {
            margin-bottom: 15px;
        }
        
        .data-value {
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1>STM32 Geräte Dashboard</h1>
            <p class="text-muted">Überwachung und Steuerung der STM32-Geräte</p>
        </div>
        <div class="col-md-auto">
            <button id="refreshBtn" class="btn btn-outline-primary">
                <i class="fas fa-sync-alt"></i> Aktualisieren
            </button>
            <button id="addDeviceBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Neues Gerät
            </button>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stm32-card">
                <div class="card-header d-flex justify-content-between">
                    <span><i class="fas fa-microchip"></i> Geräteübersicht</span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Gesamt</span>
                        <span class="badge bg-primary rounded-pill" id="totalDevices">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Online</span>
                        <span class="badge bg-success rounded-pill" id="onlineDevices">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Offline</span>
                        <span class="badge bg-danger rounded-pill" id="offlineDevices">0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Warnung</span>
                        <span class="badge bg-warning rounded-pill" id="warningDevices">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card stm32-card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i> Gesamtaktivität
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row" id="devicesContainer">
        <!-- Geräte werden hier dynamisch eingefügt -->
        <div class="col-12 text-center py-5" id="noDevicesMessage">
            <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">Keine STM32-Geräte gefunden</h4>
            <p>Klicken Sie auf "Neues Gerät", um ein STM32-Gerät hinzuzufügen.</p>
        </div>
    </div>
</div>

<!-- Modal für neues Gerät -->
<div class="modal fade" id="addDeviceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Neues STM32-Gerät hinzufügen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <form id="addDeviceForm">
                    <div class="mb-3">
                        <label for="deviceId" class="form-label">Geräte-ID</label>
                        <input type="text" class="form-control" id="deviceId" required>
                    </div>
                    <div class="mb-3">
                        <label for="deviceName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="deviceName" required>
                    </div>
                    <div class="mb-3">
                        <label for="deviceLocation" class="form-label">Standort</label>
                        <input type="text" class="form-control" id="deviceLocation">
                    </div>
                    <div class="mb-3">
                        <label for="communicationType" class="form-label">Kommunikationstyp</label>
                        <select class="form-select" id="communicationType">
                            <option value="mqtt" selected>MQTT</option>
                            <option value="http">HTTP</option>
                            <option value="ble">BLE</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="saveDeviceBtn">Speichern</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Beispiel-Chart
        const ctx = document.getElementById('activityChart').getContext('2d');
        const activityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                datasets: [{
                    label: 'Datenübertragungen',
                    data: [12, 19, 3, 5, 2, 3],
                    borderColor: '#3a7bd5',
                    tension: 0.4,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Modal-Handling
        const addDeviceBtn = document.getElementById('addDeviceBtn');
        const addDeviceModal = new bootstrap.Modal(document.getElementById('addDeviceModal'));
        const saveDeviceBtn = document.getElementById('saveDeviceBtn');
        
        addDeviceBtn.addEventListener('click', function() {
            addDeviceModal.show();
        });
        
        // Speichern eines neuen Geräts
        saveDeviceBtn.addEventListener('click', function() {
            const deviceId = document.getElementById('deviceId').value;
            const deviceName = document.getElementById('deviceName').value;
            const deviceLocation = document.getElementById('deviceLocation').value;
            const communicationType = document.getElementById('communicationType').value;
            
            if (!deviceId || !deviceName) {
                alert('Bitte füllen Sie alle Pflichtfelder aus.');
                return;
            }
            
            fetch('/api/devices/stm32/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    device_id: deviceId,
                    name: deviceName,
                    location: deviceLocation,
                    communication_type: communicationType
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Fehler beim Hinzufügen des Geräts');
                }
                return response.json();
            })
            .then(data => {
                addDeviceModal.hide();
                document.getElementById('addDeviceForm').reset();
                loadDevices(); // Geräteliste neu laden
            })
            .catch(error => {
                console.error('Fehler:', error);
                alert('Fehler beim Hinzufügen des Geräts: ' + error.message);
            });
        });
        
        // Aktualisieren der Geräteliste
        document.getElementById('refreshBtn').addEventListener('click', loadDevices);
        
        function loadDevices() {
            fetch('/api/devices?device_type=stm32')
                .then(response => response.json())
                .then(devices => {
                    updateDeviceStats(devices);
                    renderDevices(devices);
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Geräte:', error);
                });
        }
        
        function updateDeviceStats(devices) {
            const totalDevices = devices.length;
            const onlineDevices = devices.filter(d => d.status === 'online').length;
            const offlineDevices = devices.filter(d => d.status === 'offline').length;
            const warningDevices = devices.filter(d => d.status === 'maintenance' || d.status === 'error').length;
            
            document.getElementById('totalDevices').textContent = totalDevices;
            document.getElementById('onlineDevices').textContent = onlineDevices;
            document.getElementById('offlineDevices').textContent = offlineDevices;
            document.getElementById('warningDevices').textContent = warningDevices;
        }
        
        function renderDevices(devices) {
            const container = document.getElementById('devicesContainer');
            const noDevicesMsg = document.getElementById('noDevicesMessage');
            
            // Container leeren
            container.innerHTML = '';
            
            if (devices.length === 0) {
                container.appendChild(noDevicesMsg);
                return;
            }
            
            // Geräte-Karten erstellen
            devices.forEach(device => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-4';
                
                let statusClass = 'status-offline';
                if (device.status === 'online') {
                    statusClass = 'status-online';
                } else if (device.status === 'maintenance' || device.status === 'error') {
                    statusClass = 'status-warning';
                }
                
                const lastSeen = new Date(device.last_seen).toLocaleString();
                
                col.innerHTML = `
                    <div class="card stm32-card" id="device-${device.device_id}">
                        <div class="card-header d-flex justify-content-between">
                            <span><span class="status-indicator ${statusClass}"></span> ${device.name}</span>
                            <span class="badge bg-secondary">${device.device_id}</span>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col">
                                    <div class="data-label">Standort</div>
                                    <div class="data-value">${device.location || 'Nicht angegeben'}</div>
                                </div>
                                <div class="col">
                                    <div class="data-label">Status</div>
                                    <div class="data-value">${device.status}</div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col">
                                    <div class="data-label">Zuletzt gesehen</div>
                                    <div class="data-value">${lastSeen}</div>
                                </div>
                                <div class="col">
                                    <div class="data-label">Firmware</div>
                                    <div class="data-value">${device.firmware_version || 'Unbekannt'}</div>
                                </div>
                            </div>
                            
                            <div class="command-container">
                                <button class="btn btn-sm btn-outline-primary view-data-btn" data-device-id="${device.device_id}">
                                    <i class="fas fa-chart-bar"></i> Daten anzeigen
                                </button>
                                <button class="btn btn-sm btn-outline-secondary send-command-btn" data-device-id="${device.device_id}">
                                    <i class="fas fa-terminal"></i> Befehl senden
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(col);
            });
            
            // Event-Listener für Knöpfe einrichten
            document.querySelectorAll('.view-data-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deviceId = this.getAttribute('data-device-id');
                    window.location.href = `/device/${deviceId}/data`;
                });
            });
            
            document.querySelectorAll('.send-command-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deviceId = this.getAttribute('data-device-id');
                    // Hier könnte ein Modal zum Senden von Befehlen geöffnet werden
                    alert(`Befehl senden an Gerät ${deviceId} - Funktionalität noch nicht implementiert`);
                });
            });
        }
        
        // Initial Geräte laden
        loadDevices();
    });
</script>
{% endblock %}