{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Systemstatistiken -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Systemstatistiken</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <div class="border rounded p-3 text-center">
                                <h2 id="active-users-count">-</h2>
                                <p class="text-muted mb-0">Aktive Benutzer</p>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="border rounded p-3 text-center">
                                <h2 id="active-devices-count">-</h2>
                                <p class="text-muted mb-0">Aktive Geräte</p>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="border rounded p-3 text-center">
                                <h2 id="active-jobs-count">-</h2>
                                <p class="text-muted mb-0">Laufende Aufträge</p>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="border rounded p-3 text-center">
                                <h2 id="customer-count">-</h2>
                                <p class="text-muted mb-0">Kunden</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 text-end">
                        <button class="btn btn-sm btn-outline-primary" id="refresh-stats">
                            <i class="fas fa-sync-alt me-1"></i>Aktualisieren
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Serverstatus -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-server me-2"></i>Serverstatus</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            API-Server
                            <span class="badge bg-success" id="api-status">Online</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Datenbank
                            <span class="badge bg-success" id="db-status">Verbunden</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            MQTT Broker
                            <span class="badge bg-warning" id="mqtt-status">Prüfen...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Nextcloud-Verbindung
                            <span class="badge bg-warning" id="nextcloud-status">Prüfen...</span>
                        </li>
                    </ul>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>CPU-Auslastung</span>
                            <span id="cpu-usage-text">0%</span>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="cpu-usage-bar"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-1">
                            <span>Speicherauslastung</span>
                            <span id="memory-usage-text">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="memory-usage-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Aktuellste Aktivitäten -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Aktuellste Aktivitäten</h5>
                </div>
                <div class="card-body">
                    <div class="list-group" id="recent-activities">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Lade...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Schnellzugriff -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Schnellzugriff</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <a href="{{ api_base_url }}/admin/users" class="btn btn-outline-primary w-100 py-3">
                                <i class="fas fa-users mb-2 d-block" style="font-size: 2rem;"></i>
                                Benutzerverwaltung
                            </a>
                        </div>
                        <div class="col-6 mb-3">
                            <a href="{{ api_base_url }}/admin/groups" class="btn btn-outline-success w-100 py-3">
                                <i class="fas fa-user-tag mb-2 d-block" style="font-size: 2rem;"></i>
                                Gruppenverwaltung
                            </a>
                        </div>
                        <div class="col-6 mb-3">
                            <a href="{{ api_base_url }}/admin/csv-import" class="btn btn-outline-info w-100 py-3">
                                <i class="fas fa-file-csv mb-2 d-block" style="font-size: 2rem;"></i>
                                CSV-Import
                            </a>
                        </div>
                        <div class="col-6 mb-3">
                            <a href="{{ api_base_url }}/docs" class="btn btn-outline-dark w-100 py-3">
                                <i class="fas fa-book mb-2 d-block" style="font-size: 2rem;"></i>
                                API-Dokumentation
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Beispieldaten zum Testen
    const mockData = {
        stats: {
            active_users: 12,
            active_devices: 48,
            active_jobs: 7,
            customer_count: 25
        },
        system: {
            cpu_usage: 28,
            memory_usage: 42,
            mqtt_status: 'connected',
            nextcloud_status: 'connected'
        },
        activities: [
            { type: 'user_login', timestamp: '2025-04-10T08:45:12', message: 'Benutzer "admin" hat sich angemeldet', icon: 'user' },
            { type: 'new_device', timestamp: '2025-04-10T07:30:05', message: 'Neues Gerät "Entfeuchter E123" wurde registriert', icon: 'plus-circle' },
            { type: 'job_completed', timestamp: '2025-04-09T16:12:38', message: 'Auftrag "TRK-2025-042" wurde abgeschlossen', icon: 'check-circle' },
            { type: 'device_alert', timestamp: '2025-04-09T10:55:21', message: 'Gerät "Sensor S789" meldet niedrigen Batteriestand', icon: 'exclamation-triangle' },
            { type: 'data_import', timestamp: '2025-04-08T14:20:33', message: 'CSV-Import von 3 Dateien abgeschlossen', icon: 'file-import' }
        ]
    };
    
    // Funktion zum Formatieren von Zeitstempeln
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('de-CH');
    }
    
    // Serverstatus und Statistiken abrufen
    async function fetchDashboardData() {
        try {
            // In einer Produktionsumgebung würden wir hier echte API-Aufrufe machen
            // Beispiel: const response = await apiRequest('/api/admin/dashboard/stats');
            
            // Für Demonstrationszwecke verwenden wir Mock-Daten
            const data = mockData;
            
            // Statistiken aktualisieren
            document.getElementById('active-users-count').textContent = data.stats.active_users;
            document.getElementById('active-devices-count').textContent = data.stats.active_devices;
            document.getElementById('active-jobs-count').textContent = data.stats.active_jobs;
            document.getElementById('customer-count').textContent = data.stats.customer_count;
            
            // Systemstatus aktualisieren
            document.getElementById('cpu-usage-text').textContent = `${data.system.cpu_usage}%`;
            document.getElementById('cpu-usage-bar').style.width = `${data.system.cpu_usage}%`;
            
            document.getElementById('memory-usage-text').textContent = `${data.system.memory_usage}%`;
            document.getElementById('memory-usage-bar').style.width = `${data.system.memory_usage}%`;
            
            // MQTT-Status
            const mqttStatus = document.getElementById('mqtt-status');
            if (data.system.mqtt_status === 'connected') {
                mqttStatus.textContent = 'Verbunden';
                mqttStatus.className = 'badge bg-success';
            } else {
                mqttStatus.textContent = 'Getrennt';
                mqttStatus.className = 'badge bg-danger';
            }
            
            // Nextcloud-Status
            const nextcloudStatus = document.getElementById('nextcloud-status');
            if (data.system.nextcloud_status === 'connected') {
                nextcloudStatus.textContent = 'Verbunden';
                nextcloudStatus.className = 'badge bg-success';
            } else {
                nextcloudStatus.textContent = 'Getrennt';
                nextcloudStatus.className = 'badge bg-danger';
            }
            
            // Aktivitäten aktualisieren
            const activitiesContainer = document.getElementById('recent-activities');
            activitiesContainer.innerHTML = '';
            
            data.activities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'list-group-item list-group-item-action';
                activityItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">
                            <i class="fas fa-${activity.icon} me-2 text-primary"></i>
                            ${activity.message}
                        </h6>
                        <small class="text-muted">${formatTimestamp(activity.timestamp)}</small>
                    </div>
                `;
                activitiesContainer.appendChild(activityItem);
            });
            
        } catch (error) {
            console.error('Fehler beim Abrufen der Dashboard-Daten:', error);
            showAlert('Fehler beim Abrufen der Dashboard-Daten. Bitte versuchen Sie es später erneut.', 'danger');
        }
    }
    
    // Initial Daten laden
    document.addEventListener('DOMContentLoaded', function() {
        fetchDashboardData();
        
        // Aktualisierungs-Button
        document.getElementById('refresh-stats').addEventListener('click', function() {
            fetchDashboardData();
            showAlert('Dashboard-Daten aktualisiert', 'success');
        });
    });
</script>
{% endblock %}